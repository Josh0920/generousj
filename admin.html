<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Articles</title>
  <style>
    :root{
      --bg:#fff; --text:#111; --muted:#666; --border:#ddd;
      --radius:12px;
      --maxw:1100px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header{
      position:sticky; top:0; background:#fff;
      border-bottom:1px solid var(--border);
      padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:10;
    }
    header .title{font-weight:700; letter-spacing:-0.01em}
    header .sub{font-size:12px; color:var(--muted)}
    .wrap{max-width:var(--maxw); margin:0 auto; padding:18px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      background:#fff;
    }
    h2{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:260px; resize:vertical; font-family: var(--mono); font-size:13px; line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
    }
    button.primary{
      border-color:#111;
      background:#111;
      color:#fff;
    }
    button.danger{
      border-color:#111;
      background:#fff;
      color:#111;
    }
    button[disabled]{opacity:.6; cursor:not-allowed}
    .status{font-size:12px; color:var(--muted); white-space:pre-wrap; margin-top:10px}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      cursor:pointer;
    }
    .item:hover{border-color:#bbb}
    .pill{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      margin-left:8px;
    }
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hidden{display:none !important}

    /* --- Rich text editor (ADDED earlier) --- */
    .rte-toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:8px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }
    .rte-toolbar button{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      line-height:1;
    }
    .rte{
      width:100%;
      min-height:260px;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      color:var(--text);
      outline:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.5;
    }
    .rte:empty:before{
      content: attr(data-placeholder);
      color: #999;
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">Admin</div>
    <div class="sub" id="who">Not signed in</div>
  </div>
  <div class="row" style="gap:8px;flex-wrap:nowrap">
    <button id="btnNew" class="hidden">New</button>
    <button id="btnSignOut" class="hidden">Sign out</button>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:520px; margin:26px auto;">
    <h2>Sign in</h2>
    <form id="loginForm">
      <label>Email</label>
      <input id="email" type="email" autocomplete="username" required />
      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password" required />
      <div class="row" style="margin-top:12px">
        <button class="primary" type="submit" id="btnSignIn">Sign in</button>
      </div>
      <div class="status" id="loginStatus"> </div>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dash" class="hidden">
    <div class="grid">

      <!-- LEFT: LIST -->
      <div class="card">
       <h2>Your content</h2>
<div class="row">
  <input id="search" placeholder="Search…" />

  <select id="filterType" style="max-width:160px">
    <option value="all" selected>All</option>
    <option value="article">Articles</option>
    <option value="market">Bets</option>
  </select>

  <select id="filterStatus" style="max-width:160px">
    <option value="all">All</option>
    <option value="draft">Draft</option>
    <option value="published">Published</option>
  </select>
</div>

<div class="list" id="articleList"></div>
        <div class="status" id="listStatus"></div>
      </div>

      <!-- RIGHT: EDITOR -->
      <div class="card">
        <h2 id="editorTitle">Editor</h2>

        <label>Title</label>
        <input id="title" placeholder="Article title" />

        <div class="row">
          <div>
            <label>Slug (URL-friendly)</label>
            <input id="slug" class="mono" placeholder="my-article-title" />
          </div>
          <div style="max-width:220px">
            <label>Status</label>
            <select id="status">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>

        <label>Excerpt</label>
        <input id="excerpt" placeholder="1–2 sentence summary (optional)" />

        <!-- ✅ ADDED: Cover image upload UI -->
        <label>Cover image</label>
        <input id="imageFile" type="file" accept="image/*" />
        <div class="row" style="margin-top:10px">
          <button id="btnUploadImage" type="button">Upload image</button>
          <button id="btnRemoveImage" type="button">Remove image</button>
        </div>
        <div id="imagePreview" class="status">No image uploaded.</div>

        <label>Image alt text (recommended)</label>
        <input id="imageAlt" placeholder="Describe the image for accessibility" />

        <!-- ✅ ADDED: Video upload UI -->
        <label>Video (MP4)</label>
        <input id="videoFile" type="file" accept="video/mp4,video/webm,video/ogg" />
        <div class="row" style="margin-top:10px">
          <button id="btnUploadVideo" type="button">Upload video</button>
          <button id="btnRemoveVideo" type="button">Remove video</button>
        </div>
        <div id="videoPreview" class="status">No video uploaded.</div>

        <label>Content</label>

        <div class="rte-toolbar" aria-label="Formatting toolbar">
          <button type="button" data-cmd="bold"><b>B</b></button>
          <button type="button" data-cmd="italic"><i>I</i></button>
          <button type="button" data-cmd="underline"><u>U</u></button>
        </div>

        <div id="content" class="rte" contenteditable="true" data-placeholder="Start writing…"></div>

        <div class="row" style="margin-top:12px">
          <button id="btnSave" class="primary">Save</button>
          <button id="btnDelete" class="danger">Delete</button>
        </div>

        <div class="status" id="editStatus"></div>
      </div>

<!-- RIGHT: BETTING / MARKETS -->
<div class="card">
  <h2>Betting (Markets)</h2>

  <label>Question / Title</label>
  <input id="m_title" placeholder="Will ____ happen by ____?" />

  <div class="row">
    <div>
      <label>Category</label>
      <select id="m_category">
        <option value="General" selected>General</option>
        <option value="Politics">Politics</option>
        <option value="Sports">Sports</option>
        <option value="Campus">Campus</option>
        <option value="Entertainment">Entertainment</option>
        <option value="World">World</option>
      </select>
    </div>

    <div style="max-width:260px">
      <label>Closes at</label>
      <input id="m_closes" type="datetime-local" />
    </div>
  </div>

 <div class="row" style="margin-top:12px">
  <button id="m_create" class="primary" type="button">Publish Market</button>
  <button id="m_delete" class="danger" type="button">Delete Market</button>
  <button id="m_clear" type="button">Clear</button>
</div>

  <div class="status" id="m_status"></div>
</div>
    </div>
  </div>

</div>

<script type="module">
  // === Your Supabase ===
  const SUPABASE_URL = "https://gyfoaukqsgbtcyxnmgvs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable__zVZ8qNWFakc7aA-K7SZjQ_o-biHbVB";

  // --- DOM ---
  const whoEl = document.getElementById("who");

  const loginCard = document.getElementById("loginCard");
  const dash = document.getElementById("dash");

  const loginForm = document.getElementById("loginForm");
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const loginStatus = document.getElementById("loginStatus");
  const btnSignIn = document.getElementById("btnSignIn");
  const btnSignOut = document.getElementById("btnSignOut");
  const btnNew = document.getElementById("btnNew");

  const searchEl = document.getElementById("search");
  const filterStatusEl = document.getElementById("filterStatus");
  const filterTypeEl = document.getElementById("filterType");
  const articleListEl = document.getElementById("articleList");
  const listStatusEl = document.getElementById("listStatus");

  const editorTitleEl = document.getElementById("editorTitle");
  const titleEl = document.getElementById("title");
  const slugEl = document.getElementById("slug");
  const statusEl = document.getElementById("status");
  const excerptEl = document.getElementById("excerpt");
  const contentEl = document.getElementById("content");
  const editStatusEl = document.getElementById("editStatus");
  const btnSave = document.getElementById("btnSave");
  const btnDelete = document.getElementById("btnDelete");

  // ✅ ADDED: Image DOM
  const imageFileEl = document.getElementById("imageFile");
  const btnUploadImage = document.getElementById("btnUploadImage");
  const btnRemoveImage = document.getElementById("btnRemoveImage");
  const imagePreviewEl = document.getElementById("imagePreview");
  const imageAltEl = document.getElementById("imageAlt");

  // ✅ ADDED: Video DOM
  const videoFileEl = document.getElementById("videoFile");
  const btnUploadVideo = document.getElementById("btnUploadVideo");
  const btnRemoveVideo = document.getElementById("btnRemoveVideo");
  const videoPreviewEl = document.getElementById("videoPreview");

  // ✅ ADDED: Betting DOM
  const mTitleEl = document.getElementById("m_title");
  const mCategoryEl = document.getElementById("m_category");
  const mClosesEl = document.getElementById("m_closes");
  const mCreateBtn = document.getElementById("m_create");
  const mDeleteBtn = document.getElementById("m_delete");
  const mClearBtn = document.getElementById("m_clear");
  const mStatusEl = document.getElementById("m_status");

  const setMarketStatus = (m="") => (mStatusEl.textContent = m);
  const setLoginStatus = (m="") => (loginStatus.textContent = m);
  const setListStatus  = (m="") => (listStatusEl.textContent = m);
  const setEditStatus  = (m="") => (editStatusEl.textContent = m);

  // --- Helpers ---
  function slugify(str){
    return (str || "")
      .toLowerCase()
      .trim()
      .replace(/['"]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "")
      .slice(0, 80);
  }

  function showAuthedUI(userEmail){
    whoEl.textContent = userEmail ? `Signed in as ${userEmail}` : "Signed in";
    loginCard.classList.add("hidden");
    dash.classList.remove("hidden");
    btnSignOut.classList.remove("hidden");
    btnNew.classList.remove("hidden");
  }

  function showLoggedOutUI(){
    whoEl.textContent = "Not signed in";
    dash.classList.add("hidden");
    loginCard.classList.remove("hidden");
    btnSignOut.classList.add("hidden");
    btnNew.classList.add("hidden");
    setLoginStatus("");
  }

  // --- Load Supabase v2 ---
  let createClient;
  try {
    ({ createClient } = await import("https://esm.sh/@supabase/supabase-js@2"));
  } catch (e) {
    setLoginStatus("Failed to load Supabase library.");
    throw e;
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // ✅ ADDED: Storage settings + image state
  const IMAGE_BUCKET = "article-images";
  let currentImagePath = null;

  // ✅ ADDED: Video storage settings + state
  const VIDEO_BUCKET = "article-videos";
  let currentVideoPath = null;

  // ✅ ADDED: Image preview helper
  function setImagePreview(path) {
    if (!path) {
      imagePreviewEl.textContent = "No image uploaded.";
      return;
    }
    const { data } = supabase.storage.from(IMAGE_BUCKET).getPublicUrl(path);
    const url = data?.publicUrl;

    imagePreviewEl.innerHTML = url
      ? `<div class="muted" style="margin-bottom:8px">Uploaded ✅</div>
         <img src="${url}" alt="" style="max-width:100%;border:1px solid #ddd;border-radius:12px" />
         <div class="muted mono" style="margin-top:8px">${path}</div>`
      : `Uploaded ✅\n${path}`;
  }

  // ✅ ADDED: Video preview helper
  function setVideoPreview(path) {
    if (!path) {
      videoPreviewEl.textContent = "No video uploaded.";
      return;
    }

    const { data } = supabase.storage.from(VIDEO_BUCKET).getPublicUrl(path);
    const url = data?.publicUrl;

    videoPreviewEl.innerHTML = url
      ? `<div class="muted" style="margin-bottom:8px">Uploaded ✅</div>
         <video controls src="${url}" style="max-width:100%;border:1px solid #ddd;border-radius:12px"></video>
         <div class="muted mono" style="margin-top:8px">${path}</div>`
      : `Uploaded ✅\n${path}`;
  }

  // ✅ ADDED: Upload/remove events (kept near helpers, after supabase exists)
  btnUploadImage.addEventListener("click", async () => {
    setEditStatus("");

    const file = imageFileEl.files?.[0];
    if (!file) {
      setEditStatus("Choose an image file first.");
      return;
    }

    const slug = (slugEl.value || "").trim() || slugify(titleEl.value);
    if (!slug) {
      setEditStatus("Add a title (or slug) before uploading.");
      return;
    }

    btnUploadImage.disabled = true;
    setEditStatus("Uploading image…");

    try {
      const { data: sess, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) throw sessErr;
      const userId = sess?.session?.user?.id;
      if (!userId) throw new Error("Not signed in.");

      const ext = (file.name.split(".").pop() || "jpg")
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "") || "jpg";

      const path = `${userId}/${slug}/cover-${Date.now()}.${ext}`;

      const { error } = await supabase.storage
        .from(IMAGE_BUCKET)
        .upload(path, file, {
          cacheControl: "3600",
          upsert: false,
          contentType: file.type || undefined
        });

      if (error) throw error;

      currentImagePath = path;
      setImagePreview(currentImagePath);
      setEditStatus("Image uploaded ✅ (now click Save to attach it to the article).");
    } catch (e) {
      setEditStatus("Upload error: " + (e?.message ?? String(e)));
    } finally {
      btnUploadImage.disabled = false;
    }
  });

  btnRemoveImage.addEventListener("click", () => {
    currentImagePath = null;
    imageFileEl.value = "";
    setImagePreview(null);
    setEditStatus("Image removed (click Save to store this change).");
  });

  // ✅ ADDED: Upload/remove video events
  btnUploadVideo.addEventListener("click", async () => {
    setEditStatus("");

    const file = videoFileEl.files?.[0];
    if (!file) {
      setEditStatus("Choose a video file first.");
      return;
    }

    const slug = (slugEl.value || "").trim() || slugify(titleEl.value);
    if (!slug) {
      setEditStatus("Add a title (or slug) before uploading.");
      return;
    }

    btnUploadVideo.disabled = true;
    setEditStatus("Uploading video…");

    try {
      const { data: sess, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) throw sessErr;
      const userId = sess?.session?.user?.id;
      if (!userId) throw new Error("Not signed in.");

      const ext = (file.name.split(".").pop() || "mp4")
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "") || "mp4";

      const path = `${userId}/${slug}/video-${Date.now()}.${ext}`;

      const { error } = await supabase.storage
        .from(VIDEO_BUCKET)
        .upload(path, file, {
          cacheControl: "3600",
          upsert: false,
          contentType: file.type || undefined
        });

      if (error) throw error;

      currentVideoPath = path;
      setVideoPreview(currentVideoPath);

      // Insert <video> tag into the editor body automatically
      const { data: pub } = supabase.storage.from(VIDEO_BUCKET).getPublicUrl(path);
      const url = pub?.publicUrl;

      if (url) {
        contentEl.insertAdjacentHTML(
          "beforeend",
          `<br><video controls src="${url}"></video><br>`
        );
      }

      setEditStatus("Video uploaded ✅ (now click Save to keep the article changes).");
    } catch (e) {
      setEditStatus("Video upload error: " + (e?.message ?? String(e)));
    } finally {
      btnUploadVideo.disabled = false;
    }
  });

  btnRemoveVideo.addEventListener("click", () => {
    currentVideoPath = null;
    videoFileEl.value = "";
    setVideoPreview(null);
    setEditStatus("Video removed from the editor view (click Save to store this change).");
  });

  // --- State ---
  let currentUser = null;
  let selectedArticleId = null;
  let articlesCache = [];
  let marketsCache = [];
  let selectedMarketId = null;

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  /* ✅ ADDED: normalize editor HTML so it saves like old text (line breaks), but keeps <b>/<i>/<u> */
  function normalizeArticleHtml(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = (html || "");

    // Convert <div>/<p> blocks into inline content + <br>
    tmp.querySelectorAll("div,p").forEach(el => {
      const frag = document.createDocumentFragment();
      while (el.firstChild) frag.appendChild(el.firstChild);
      frag.appendChild(document.createElement("br"));
      el.replaceWith(frag);
    });

    let out = tmp.innerHTML;

    // Remove trailing breaks
    out = out.replace(/(<br>\s*)+$/i, "");

    return out;
  }

  function clearEditor(){
    selectedArticleId = null;
    editorTitleEl.textContent = "Editor (new)";
    titleEl.value = "";
    slugEl.value = "";
    excerptEl.value = "";
    contentEl.innerHTML = "";
    statusEl.value = "draft";
    setEditStatus("");

    // ✅ ADDED: reset image fields
    currentImagePath = null;
    imageAltEl.value = "";
    imageFileEl.value = "";
    setImagePreview(null);

    // ✅ ADDED: reset video fields
    currentVideoPath = null;
    videoFileEl.value = "";
    setVideoPreview(null);
  }

  function fillEditor(a){
    selectedArticleId = a.id;
    editorTitleEl.textContent = "Editor (editing)";
    titleEl.value = a.title || "";
    slugEl.value = a.slug || "";
    excerptEl.value = a.excerpt || "";

    const b = a.body || "";
    const looksLikeHtml = /<\/?[a-z][\s\S]*>/i.test(b);
    contentEl.innerHTML = looksLikeHtml ? b : escapeHtml(b).replace(/\n/g, "<br>");

    statusEl.value = a.status || "draft";
    setEditStatus("");

    // ✅ ADDED: load image fields
    currentImagePath = a.image_path || null;
    imageAltEl.value = a.image_alt || "";
    setImagePreview(currentImagePath);

    // ✅ ADDED: reset video preview (videos are stored in the body HTML)
    currentVideoPath = null;
    videoFileEl.value = "";
    setVideoPreview(null);
  }

  function renderList(){
    const q = (searchEl.value || "").trim().toLowerCase();
    const st = filterStatusEl.value;
    const ty = filterTypeEl ? filterTypeEl.value : "all";

    const combined = [];

    // ---- Articles ----
    if (ty === "all" || ty === "article") {
      for (const a of articlesCache) {
        const matchesText =
          !q ||
          (a.title || "").toLowerCase().includes(q) ||
          (a.slug || "").toLowerCase().includes(q);

        const matchesStatus = (st === "all") || ((a.status || "draft") === st);

        if (matchesText && matchesStatus) {
          combined.push({
            type: "article",
            sortDate: a.updated_at || a.created_at,
            data: a
          });
        }
      }
    }

    // ---- Markets / Bets ----
    if (ty === "all" || ty === "market") {
      for (const m of marketsCache) {
        const matchesText =
          !q ||
          (m.title || "").toLowerCase().includes(q) ||
          (m.category || "").toLowerCase().includes(q);

        // status filter does not apply to markets, so only show them when status filter is "all"
        const matchesStatus = (st === "all");

        if (matchesText && matchesStatus) {
          combined.push({
            type: "market",
            sortDate: m.updated_at || m.created_at,
            data: m
          });
        }
      }
    }

    combined.sort((x, y) => new Date(y.sortDate) - new Date(x.sortDate));

    articleListEl.innerHTML = "";
    if (!combined.length) {
      articleListEl.innerHTML = `<div class="muted" style="padding:10px">No results.</div>`;
      return;
    }

    for (const item of combined) {
      const div = document.createElement("div");
      div.className = "item";

      if (item.type === "article") {
        const a = item.data;
        div.innerHTML = `
          <div style="font-weight:650">${escapeHtml(a.title || "(untitled)")}
            <span class="pill">article</span>
            <span class="pill">${escapeHtml(a.status || "draft")}</span>
          </div>
          <div class="muted mono" style="font-size:12px; margin-top:4px;">/${escapeHtml(a.slug || "")}</div>
          <div class="muted" style="font-size:12px; margin-top:6px;">${new Date(a.updated_at || a.created_at).toLocaleString()}</div>
        `;
        div.addEventListener("click", () => fillEditor(a));
      } else {
        const m = item.data;
        const closesTxt = m.closes_at ? new Date(m.closes_at).toLocaleString() : "—";
        div.innerHTML = `
          <div style="font-weight:650">${escapeHtml(m.title || "(untitled market)")}
            <span class="pill">bet</span>
            <span class="pill">${escapeHtml(m.category || "General")}</span>
          </div>
          <div class="muted" style="font-size:12px; margin-top:6px;">Closes: ${closesTxt}</div>
          <div class="muted" style="font-size:12px; margin-top:6px;">${new Date(m.updated_at || m.created_at).toLocaleString()}</div>
        `;
        div.addEventListener("click", () => {
          selectedMarketId = m.id;
          mTitleEl.value = m.title || "";
          mCategoryEl.value = m.category || "General";

          // ISO -> datetime-local
          if (m.closes_at) {
            const d = new Date(m.closes_at);
            if (!isNaN(d.getTime())) {
              const pad = (n) => String(n).padStart(2, "0");
              const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
              mClosesEl.value =
                `${local.getFullYear()}-${pad(local.getMonth()+1)}-${pad(local.getDate())}T${pad(local.getHours())}:${pad(local.getMinutes())}`;
            } else {
              mClosesEl.value = "";
            }
          } else {
            mClosesEl.value = "";
          }

          if (mCreateBtn) mCreateBtn.textContent = "Update Market";
          setMarketStatus("Loaded bet ✅");
        });
      }

      articleListEl.appendChild(div);
    }
  }

  async function loadArticles(){
    setListStatus("Loading…");
    const { data, error } = await supabase
      .from("articles")
      .select("id,title,slug,excerpt,body,status,image_path,image_alt,created_at,updated_at")
      .order("updated_at", { ascending: false });

    if (error) {
      setListStatus("Error loading: " + error.message);
      articlesCache = [];
      renderList();
      return;
    }

    articlesCache = data || [];
    setListStatus("");
    renderList();
  }

  async function loadMarkets(){
    const { data, error } = await supabase
      .from("markets")
      .select("id,title,category,closes_at,yes_votes,no_votes,created_at")
      .order("created_at", { ascending: false });

    if (error) {
      setListStatus("Error loading markets: " + error.message);
      marketsCache = [];
      renderList();
      return;
    }

    // add a safe updated_at fallback so renderList sorting still works
    marketsCache = (data || []).map(m => ({
      ...m,
      updated_at: m.updated_at ?? m.created_at
    }));

    renderList();
  }

  // --- Events ---

  // Toolbar handler (kept)
  document.querySelectorAll(".rte-toolbar [data-cmd]").forEach(btn => {
    btn.addEventListener("click", () => {
      const cmd = btn.getAttribute("data-cmd");
      document.execCommand(cmd, false, null);
      contentEl.focus();
    });
  });

  /* ✅ ADDED: make editor behave like old textarea:
     - Enter inserts <br> (not <div>/<p>)
     - Paste inserts plain text (no formatting garbage)
  */
  contentEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      document.execCommand("insertLineBreak");
    }
  });

  contentEl.addEventListener("paste", (e) => {
    e.preventDefault();

    const cd = (e.clipboardData || window.clipboardData);
    const html = cd ? (cd.getData("text/html") || "") : "";
    const text = cd ? (cd.getData("text/plain") || "") : "";

    if (html && (/<iframe[\s>]/i.test(html) || /<video[\s>]/i.test(html) || /<source[\s>]/i.test(html))) {
      document.execCommand("insertHTML", false, html);
      return;
    }

    document.execCommand("insertText", false, text);
  });

  titleEl.addEventListener("input", () => {
    // Only auto-generate slug if creating new or slug is empty
    if (!selectedArticleId && !slugEl.value.trim()) {
      slugEl.value = slugify(titleEl.value);
    }
  });

  btnNew.addEventListener("click", () => {
    clearEditor();
    titleEl.focus();
  });

  searchEl.addEventListener("input", renderList);
  filterStatusEl.addEventListener("change", renderList);
  filterTypeEl.addEventListener("change", renderList);

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    setLoginStatus("");

    const email = (emailEl.value || "").trim();
    const password = passEl.value || "";

    if (!email || !password) {
      setLoginStatus("Enter email + password.");
      return;
    }

    btnSignIn.disabled = true;
    setLoginStatus("Signing in…");

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    btnSignIn.disabled = false;

    if (error) {
      setLoginStatus("Sign-in error: " + error.message);
      return;
    }

    currentUser = data.user;
    showAuthedUI(currentUser?.email);
    clearEditor();
    await loadArticles();
    await loadMarkets();
  });

  btnSignOut.addEventListener("click", async () => {
    await supabase.auth.signOut();
    currentUser = null;
    showLoggedOutUI();
  });

  btnSave.addEventListener("click", async () => {
    setEditStatus("");

    const title = (titleEl.value || "").trim();
    const slug = (slugEl.value || "").trim();
    const excerpt = (excerptEl.value || "").trim();
    const body = normalizeArticleHtml((contentEl.innerHTML || "")).trim();
    const status = statusEl.value;

    // ✅ ADDED: image fields
    const image_path = currentImagePath;
    const image_alt = (imageAltEl.value || "").trim();

    if (!title) return setEditStatus("Title is required.");
    if (!slug) return setEditStatus("Slug is required.");
    if (!body) return setEditStatus("Content is required.");

    btnSave.disabled = true;
    setEditStatus("Saving…");

    try {
      if (selectedArticleId) {
        const { error } = await supabase
          .from("articles")
          .update({ title, slug, excerpt, body, status, image_path, image_alt })
          .eq("id", selectedArticleId);

        if (error) throw error;
        setEditStatus("Saved ✅");
      } else {
        const { data, error } = await supabase
          .from("articles")
          .insert([{ title, slug, excerpt, body, status, image_path, image_alt }])
          .select("id")
          .single();

        if (error) throw error;
        selectedArticleId = data.id;
        editorTitleEl.textContent = "Editor (editing)";
        setEditStatus("Created ✅");
      }

      await loadArticles();
      await loadMarkets();
    } catch (e) {
      setEditStatus("Save error: " + (e?.message ?? String(e)));
    } finally {
      btnSave.disabled = false;
    }
  });

  btnDelete.addEventListener("click", async () => {
    if (!selectedArticleId) {
      setEditStatus("Nothing to delete.");
      return;
    }
    const ok = confirm("Delete this article? This cannot be undone.");
    if (!ok) return;

    btnDelete.disabled = true;
    setEditStatus("Deleting…");

    try {
      const { error } = await supabase
        .from("articles")
        .delete()
        .eq("id", selectedArticleId);

      if (error) throw error;

      clearEditor();
      setEditStatus("Deleted ✅");
      await loadArticles();
      await loadMarkets();
    } catch (e) {
      setEditStatus("Delete error: " + (e?.message ?? String(e)));
    } finally {
      btnDelete.disabled = false;
    }
  });

  // ==========================
  // ✅ BETTING: Create markets
  // ==========================
  function clearMarketForm(){
    if (mTitleEl) mTitleEl.value = "";
    if (mCategoryEl) mCategoryEl.value = "General";
    if (mClosesEl) mClosesEl.value = "";
    selectedMarketId = null;
    if (mCreateBtn) mCreateBtn.textContent = "Publish Market";
    setMarketStatus("");
  }

  async function createMarket(){
    setMarketStatus("");

    // Require being signed in (matches your admin-only intent)
    const { data: sess } = await supabase.auth.getSession();
    if (!sess?.session?.user) {
      setMarketStatus("You must be signed in to publish a market.");
      return;
    }

    const title = (mTitleEl?.value || "").trim();
    const category = (mCategoryEl?.value || "General").trim();
    const closesLocal = mClosesEl?.value;

    if (!title) return setMarketStatus("Title is required.");
    if (!closesLocal) return setMarketStatus("Closes-at date/time is required.");

    const closesAt = new Date(closesLocal);
    if (isNaN(closesAt.getTime())) return setMarketStatus("Invalid closes-at date/time.");

    mCreateBtn.disabled = true;
    setMarketStatus(selectedMarketId ? "Updating market…" : "Publishing market…");

    try {
      if (selectedMarketId) {
        const { error } = await supabase
          .from("markets")
          .update({
            title,
            category,
            closes_at: closesAt.toISOString()
          })
          .eq("id", selectedMarketId);

        if (error) throw error;

        setMarketStatus("Updated ✅");
      } else {
        const { data, error } = await supabase
          .from("markets")
          .insert([{
            title,
            category,
            closes_at: closesAt.toISOString(),
            yes_votes: 0,
            no_votes: 0
          }])
          .select("id")
          .single();

        if (error) throw error;

        selectedMarketId = data?.id ?? null;
        if (mCreateBtn) mCreateBtn.textContent = "Update Market";
        setMarketStatus("Published ✅");
      }

      await loadMarkets();
    } catch (e) {
      setMarketStatus((selectedMarketId ? "Update" : "Publish") + " error: " + (e?.message ?? String(e)));
    } finally {
      mCreateBtn.disabled = false;
    }
  }

  async function deleteMarket(){
    setMarketStatus("");

    if (!selectedMarketId){
      setMarketStatus("Select a bet in 'Your content' first.");
      return;
    }

    const ok = confirm("Delete this bet? This cannot be undone.");
    if (!ok) return;

    mDeleteBtn.disabled = true;
    setMarketStatus("Deleting…");

    try {
      // delete votes first (handles FK constraints if votes exist)
      const { error: votesErr } = await supabase
        .from("votes")
        .delete()
        .eq("market_id", selectedMarketId);

      if (votesErr) throw votesErr;

      const { error } = await supabase
        .from("markets")
        .delete()
        .eq("id", selectedMarketId);

      if (error) throw error;

      selectedMarketId = null;
      clearMarketForm();
      setMarketStatus("Deleted ✅");
      await loadMarkets();
    } catch (e) {
      console.error(e);
      setMarketStatus("Delete error: " + (e?.message ?? String(e)) + " (Check RLS policies.)");
    } finally {
      mDeleteBtn.disabled = false;
    }
  }

  mCreateBtn?.addEventListener("click", createMarket);
  mDeleteBtn?.addEventListener("click", deleteMarket);
  mClearBtn?.addEventListener("click", clearMarketForm);

  // --- Boot: if already signed in, show dashboard ---
  const { data: sess } = await supabase.auth.getSession();
  if (sess?.session?.user) {
    currentUser = sess.session.user;
    showAuthedUI(currentUser.email);
    clearEditor();
    await loadArticles();
    await loadMarkets();
  } else {
    showLoggedOutUI();
  }
</script>
</body>
</html>
