<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Login</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --border:#d9d9d9;
      --btn:#111111;
      --btnText:#ffffff;
      --radius:12px;
    }
    html, body { height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:420px;
      padding:28px 18px;
    }
    h1{
      margin:0 0 8px;
      font-size:22px;
      letter-spacing:-0.01em;
    }
    p{
      margin:0 0 18px;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }
    label{
      display:block;
      margin:14px 0 6px;
      font-size:13px;
      color:var(--text);
    }
    input{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    input:focus{
      border-color:#999;
    }
    .row{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    button{
      width:100%;
      padding:12px 12px;
      border-radius:var(--radius);
      border:1px solid var(--btn);
      background:var(--btn);
      color:var(--btnText);
      font-weight:650;
      font-size:15px;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      font-weight:600;
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    .status{
      margin-top:14px;
      font-size:13px;
      color:var(--muted);
      white-space:pre-wrap;
      border-top:1px solid #eee;
      padding-top:12px;
      min-height:18px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin</h1>
    <p>Sign in to create or edit articles.</p>

    <form id="loginForm" autocomplete="on">
      <label for="email">Email</label>
      <input id="email" name="email" type="email" autocomplete="username" placeholder="you@email.com" required />

      <label for="password">Password</label>
      <input id="password" name="password" type="password" autocomplete="current-password" placeholder="Password" required />

      <div class="row">
        <button id="btnSignIn" type="submit">Sign in</button>
        <button id="btnSignOut" class="secondary" type="button">Sign out</button>
      </div>
    </form>

    <div id="status" class="status">Ready.</div>
  </div>

  <script type="module">
    // === Supabase config (yours) ===
    const SUPABASE_URL = "https://gyfoaukqsgbtcyxnmgvs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable__zVZ8qNWFakc7aA-K7SZjQ_o-biHbVB";

    // ✅ Redirect target (use absolute to avoid folder path issues)
    const REDIRECT_TO = "/article.html";

    const statusEl = document.getElementById("status");
    const form     = document.getElementById("loginForm");
    const emailEl  = document.getElementById("email");
    const passEl   = document.getElementById("password");
    const btnIn    = document.getElementById("btnSignIn");
    const btnOut   = document.getElementById("btnSignOut");

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log("[admin]", msg);
    }

    // Load Supabase JS v2
    let createClient;
    try {
      ({ createClient } = await import("https://esm.sh/@supabase/supabase-js@2"));
    } catch (e) {
      setStatus("Failed to load Supabase library.");
      throw e;
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    function redirectNow() {
      setStatus("Redirecting…");
      // small delay helps session persist before new page loads
      setTimeout(() => {
        window.location.href = REDIRECT_TO;
      }, 120);
    }

    // If already signed in, redirect immediately on load
    async function init() {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        setStatus("Session error: " + error.message);
        return;
      }
      if (data.session) {
        redirectNow();
      } else {
        setStatus("Ready.");
      }
    }

    // Login submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = (emailEl.value || "").trim();
      const password = passEl.value || "";

      if (!email || !password) {
        setStatus("Enter email + password.");
        return;
      }

      btnIn.disabled = true;
      setStatus("Signing in…");

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          setStatus("Sign-in error: " + error.message);
          return;
        }
        if (data?.session || data?.user) {
          redirectNow();
        } else {
          setStatus("Signed in, but no session returned.");
        }
      } catch (err) {
        setStatus("Sign-in failed: " + (err?.message ?? String(err)));
      } finally {
        btnIn.disabled = false;
      }
    });

    // Sign out
    btnOut.addEventListener("click", async () => {
      btnOut.disabled = true;
      setStatus("Signing out…");
      try {
        const { error } = await supabase.auth.signOut();
        if (error) setStatus("Sign-out error: " + error.message);
        else setStatus("Signed out.");
      } finally {
        btnOut.disabled = false;
      }
    });

    await init();
  </script>
</body>
</html>
